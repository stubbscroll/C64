/* convert .c files from the petscii editor at
   http://www.kameli.net/marq/?page_id=2717
   into a .prg file that views the pages
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

/* the binary */
#define LENGTH 2458
unsigned char binary[LENGTH]={
1,8,11,8,10,0,158,52,48,57,54,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,120,162,19,
160,17,142,250,255,140,251,255,162,252,160,16,142,254,255,140,255,255,169,
62,141,18,208,169,11,141,17,208,169,127,141,13,220,169,1,141,26,208,
169,53,133,1,169,0,141,32,208,169,0,141,33,208,169,20,141,24,208,
169,200,141,22,208,169,3,141,0,221,169,0,133,97,133,98,133,99,141,
21,208,170,157,0,8,232,208,250,32,20,17,169,247,205,18,208,208,251,
88,165,97,41,7,73,7,9,16,141,17,208,169,18,141,24,208,165,98,
133,100,165,97,70,100,106,70,100,106,70,100,106,170,32,0,98,164,99,
174,1,220,138,41,16,240,26,138,41,32,240,8,174,0,220,138,41,1,
208,8,192,248,240,28,136,76,189,16,138,41,2,208,8,192,8,240,15,
200,76,189,16,192,0,240,7,48,4,136,76,189,16,200,132,99,152,240,
55,16,22,24,101,97,133,97,176,12,198,98,16,8,169,0,133,97,133,
98,133,99,76,249,16,24,101,97,133,97,144,2,230,98,165,97,201,88,
165,98,233,2,144,12,169,88,133,97,169,2,133,98,169,0,133,99,76,
91,16,72,138,72,162,6,202,208,253,234,169,20,141,24,208,14,25,208,
173,13,220,104,170,104,64,169,0,133,100,162,40,160,4,134,102,132,103,
162,40,160,216,134,104,132,105,162,0,160,98,134,106,132,107,160,0,162,
0,169,189,32,145,17,165,100,32,145,17,138,10,105,18,32,145,17,169,
141,32,145,17,165,102,32,145,17,165,103,32,145,17,230,102,208,2,230,
103,169,189,32,145,17,165,100,32,145,17,138,10,56,105,18,32,145,17,
169,141,32,145,17,165,104,32,145,17,165,105,32,145,17,230,104,208,2,
230,105,232,224,40,208,174,166,100,232,134,100,224,24,208,163,169,96,145,
106,200,208,2,230,107,96
};

unsigned char text[20480];
int at;
int col[2];

void usage() {
	puts("this program takes screen files (in .c format) from the petscii editor at");
	puts("kameli.net and creates an executable that views the files.\n");
	puts("usage:");
	puts("conv file1 file2 ... out.prg\n");
	puts("where file1, file2 etc are the input screens (in .c format) and out.prg");
	puts("is an unpacked executable doc viewer. the");
	exit(0);
}

void init() {
	int i;
	for(i=0;i<20480;i++) text[i]=0;
	at=0;
}

void parsenum(char *s,int *a,int n) {
	int i,v;
	for(i=0;i<n;i++) {
		v=0;
		if(!isdigit(*s)) {
			printf("parse error, expected digit.\n");
			exit(1);
		}
		while(isdigit(*s)) v=v*10+*(s++)-48;
		if(*s==',') s++;
		a[i]=v;
	}
}

void conv(char *file) {
	char s[10000];
	int temp[40];
	FILE *f=fopen(file,"r");
	if(!f) {
		printf("error opening file %s.\n",file);
		exit(1);
	}
	fgets(s,10000,f);
	if(strncmp("unsigned char",s,13)) {
		printf("not correct file format in %s.\n",file);
		exit(1);
	}
	/* get border and background colours */
	fgets(s,10000,f);
	parsenum(s,col,2);
	/* get screen, one row at a time */
	for(int i=0;i<25;i++) {
		fgets(s,10000,f);
		parsenum(s,temp,40);
		for(int j=0;j<40;j++) text[at+i+j*512]=temp[j];
	}
	/* get colour memory, one row at a time */
	for(int i=0;i<25;i++) {
		fgets(s,10000,f);
		parsenum(s,temp,40);
		for(int j=0;j<40;j++) text[256+at+i+j*512]=temp[j];
	}
	fclose(f);
	at+=25;
}

void save(char *file) {
	int zero[1]={0};
	/* patch the binary */
	binary[0x82f]=col[0]; /* $d020 */
	binary[0x834]=col[1]; /* $d021 */
	int maxpos=(at-23)*8;
	binary[0x8e7]=maxpos&255;
	binary[0x8eb]=maxpos>>8;
	binary[0x8ef]=maxpos&255;
	binary[0x8f3]=maxpos>>8;
	/* put together the pieces and save */
	FILE *f=fopen(file,"wb");
	if(!f) {
		printf("error saving to %s.\n",file);
		exit(1);
	}
	fwrite(binary,1,LENGTH,f);
	/* pad space between code and text with zeroes */
	for(int i=LENGTH;i<2560+1;i++) fwrite(zero,1,1,f);
	fwrite(text,1,20480,f);
	fclose(f);
	puts("done.");
}

int main(int argc, char **argv) {
	puts("petscii-conv 1.0 by scroll/megastyle in 2018\n");
	if(argc==1) usage();
	init();
	for(int i=1;i<argc-1;i++) conv(argv[i]);
	save(argv[argc-1]);
	return 0;
}
